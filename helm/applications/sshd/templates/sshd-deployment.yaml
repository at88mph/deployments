{{- $storageSpec := .Values.storageSpec -}}
{{- $rootPath := .Values.rootPath -}}

---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    run: {{ .Release.Name }}-process
  name: {{ .Release.Name }}-process
  namespace: {{ .Release.Namespace }}
spec:
  replicas: {{ default 1 .Values.replicaCount }}
  selector:
    matchLabels:
      run: {{ .Release.Name }}-process
  template:
    metadata:
      creationTimestamp: null
      labels:
        run: {{ .Release.Name }}-process
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: nvidia.com/gpu.count
                operator: DoesNotExist
      {{- with .Values.extraHosts }}
      hostAliases:
      {{- range $extraHost := . }}
        - ip: {{ $extraHost.ip }}
          hostnames:
            - {{ $extraHost.hostname }}
      {{- end }}
      {{- end }}
      containers:
      - image: {{ include "common.image" ( dict "imageObject" .Values.image ) }}
        imagePullPolicy: Always
        name: {{ .Release.Name }}-process
        env:
        {{- with .Values.extraEnv }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        {{- with .Values.resources }}
        resources:
          {{- toYaml . | nindent 8 }}
        {{- end }}
        ports:
        - containerPort: 2222
          protocol: TCP
        volumeMounts:
        - mountPath: /etc/ssh/ssh_host_ecdsa_key.pub
          name: ssh-host-ecdsa-key-pub
        - mountPath: /etc/ssh/ssh_host_ed25519_key.pub
          name: ssh-host-ed25519-key-pub
        - mountPath: /etc/ssh/ssh_host_rsa_key.pub
          name: ssh-host-rsa-key-pub
        - mountPath: /etc/ssh/ssh_host_ecdsa_key
          name: {{ .Release.Name }}-config
          subPath: ssh_host_ecdsa_key
        - mountPath: /etc/ssh/ssh_host_ed25519_key
          name: {{ .Release.Name }}-config
          subPath: ssh_host_ed25519_key
        - mountPath: /etc/ssh/ssh_host_rsa_key
          name: {{ .Release.Name }}-config
          subPath: ssh_host_rsa_key
        - mountPath: /etc/ssh/sshd_config
          name: {{ .Release.Name }}-config
          subPath: sshd_config
        - mountPath: /etc/sssd/sssd.conf
          subPath: sssd.conf
          name: sssd-config
        - mountPath: "{{ if $rootPath }}{{ $rootPath }}{{ else }}{{ required ".rootPath is missing.  This value indicates the parent folder of the /home and /projects folder.  This is also called the TLD in Skaha." .Values.rootPath }}{{ end }}"
          name: cavern-volume
          subPath: {{ if $rootPath }}{{ $rootPath | regexFind "[^/].*$" }}{{ else }}{{ required ".rootPath is missing.  This value indicates the parent folder of the /home and /projects folder.  This is also called the TLD in Skaha." .Values.rootPath }}{{ end }}
        {{- if .Values.extraVolumeMounts }}
        {{- toYaml .Values.extraVolumeMounts | nindent 8 }}
        {{- else }}
        {{- required "extraVolumeMounts is required. If you don't have extra volume mounts, provide an empty list []" .Values.extraVolumeMounts }}
        {{- end }}
      priorityClassName: uber-user-preempt-high
      serviceAccountName: skaha
      volumes:
      - name: sssd-config
        secret:
          # Decimal equivalent to 0600 octal
          defaultMode: 384
          secretName: sssd-config
      - name: {{ .Release.Name }}-config
        secret:
          # Decimal equivalent to 0600 octal
          defaultMode: 384
          secretName: {{ .Release.Name }}-config
      - name: ssh-host-rsa-key-pub
        emptyDir: {}
      - name: ssh-host-ecdsa-key-pub
        emptyDir: {}
      - name: ssh-host-ed25519-key-pub
        emptyDir: {}
      - name: cavern-volume
        {{- if $storageSpec }}
        {{- toYaml $storageSpec | nindent 8 }}
        {{- else }}
        {{- required ".storageSpec is missing.  This should declare the configuration of the underlying storage." .Values.storageSpec }}
        {{- end }}
      {{- if .Values.extraVolumes }}
      {{- toYaml .Values.extraVolumes | nindent 6 }}
      {{- else }}
      {{- required "extraVolumes is required. If you don't have extra volumes, provide an empty list []" .Values.extraVolumes }}
      {{- end }}
